
SELECT * FROM students;
SELECT * FROM teachers;
SELECT * FROM courses;
SELECT * FROM department;
SELECT * FROM student_address;
SELECT * FROM annex_building;
SELECT * FROM main_building; --name student, course, teacher, buildingname, department

--JOIN TABLE
SELECT students.full_name as StudentName, students.email , courses.course_name as Course,
          teachers.full_name as TeacherName,
          department.department_name as department,
          main_building.building_name as buildingname
         FROM students
JOIN courses on students.course_id = courses.course_id
JOIN teachers on courses.course_id = teachers.course_id
JOIN department on courses.department_id = department.department_id
JOIN main_building on department.department_building_id = main_building.building_id


--FETCH STUDENT DATA

CREATE OR REPLACE FUNCTION get_student_info()
RETURNS TABLE (
    student_id INT,
    student_name VARCHAR,
    course_name VARCHAR,
    teacher_name VARCHAR,
    department_name VARCHAR,
    building_name VARCHAR
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        s.student_id,
        s.full_name AS student_name,
        c.course_name AS course_name,
        t.full_name AS teacher_name,
        d.department_name AS department_name,
        b.building_name AS building_name
    FROM students s
    JOIN courses c ON s.course_id = c.course_id
    LEFT JOIN teachers t ON c.course_id = t.course_id
    JOIN department d ON c.department_id = d.department_id
    JOIN main_building b ON d.department_building_id = b.building_id;
END;
$$;



SELECT * FROM get_student_info()
WHERE student_id = 59;



--------------------------------------------------------------------------------------------------------------------------------------


--POST STUDENT

CREATE OR REPLACE PROCEDURE add_student_test(
    p_full_name VARCHAR,
    p_gender CHAR,
    p_birth_date DATE,
    p_email VARCHAR,
    p_phone_number VARCHAR,
    p_course_id INT
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_student_id INT;
    v_course_name VARCHAR;
    v_department_id INT;
BEGIN
    -- Generate next student_id manually
    SELECT COALESCE(MAX(student_id), 0) + 1 INTO v_student_id FROM students;

    -- Check if email already exists
    IF EXISTS (SELECT 1 FROM students WHERE email = p_email) THEN
        RAISE NOTICE 'Email % already exists. Student not added.', p_email;
        RETURN;
    END IF;

    -- Check if name already exists
    IF EXISTS (SELECT 1 FROM students WHERE full_name = p_full_name) THEN
        RAISE NOTICE 'Student name % already exists. Student not added.', p_full_name;
        RETURN;
    END IF;

    -- Get course name and department_id automatically using course_id
    SELECT course_name, department_id
    INTO v_course_name, v_department_id
    FROM courses
    WHERE course_id = p_course_id;

    -- If no course found
    IF v_course_name IS NULL THEN
        RAISE NOTICE 'Course ID % not found. Student not added.', p_course_id;
        RETURN;
    END IF;

    -- Insert new student
    INSERT INTO students (
        student_id, full_name, gender, birth_date,
        email, phone_number, course, course_id, department_id
    )
    VALUES (
        v_student_id, p_full_name, p_gender, p_birth_date,
        p_email, p_phone_number, v_course_name, p_course_id, v_department_id
    );

    -- Success message
    RAISE NOTICE 
        'Student % (ID: %) added successfully under course % (Course ID: %, Department ID: %).',
        p_full_name, v_student_id, v_course_name, p_course_id, v_department_id;
END;
$$;

CALL add_student_test(
    'Angela Reyes',
    'F',
    '2004-05-20',
    'angela.reyes@school.edu',
    '09987654321',
    105
);

--------------------------------------------------------------------------------------------------------------------------------------




--POST TEACHER

CREATE OR REPLACE PROCEDURE add_teacher_test(
    p_full_name VARCHAR,
    p_gender CHAR,
    p_email VARCHAR,
    p_phone_number VARCHAR,
    p_course_id INT
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_teacher_id INT;
    v_course_name VARCHAR;
    v_department_id INT;
    v_building_id INT;
BEGIN
    -- Generate next teacher_id manually
    SELECT COALESCE(MAX(teacher_id), 0) + 1 INTO v_teacher_id FROM teachers;

    -- Check if email already exists
    IF EXISTS (SELECT 1 FROM teachers WHERE email = p_email) THEN
        RAISE NOTICE 'Email % already exists. Teacher not added.', p_email;
        RETURN;
    END IF;

    --Add check if the course is already occupied
    IF EXISTS (SELECT 1 FROM courses WHERE course_id = p_course_id) THEN
            RAISE NOTICE 'Course % already exists. Teacher not added.', p_course_id;
            RETURN;
        END IF;



    -- Check if name already exists
    IF EXISTS (SELECT 1 FROM teachers WHERE full_name = p_full_name) THEN
        RAISE NOTICE 'Teacher name % already exists. Teacher not added.', p_full_name;
        RETURN;
    END IF;

    -- Get course_name and department_id automatically from courses
    SELECT course_name, department_id
    INTO v_course_name, v_department_id
    FROM courses
    WHERE course_id = p_course_id;

    -- If course not found
    IF v_course_name IS NULL THEN
        RAISE NOTICE 'Course ID % not found. Teacher not added.', p_course_id;
        RETURN;
    END IF;

    -- Get building_id automatically from department
    SELECT department_building_id
    INTO v_building_id
    FROM department
    WHERE department_id = v_department_id;

    -- If no building found
    IF v_building_id IS NULL THEN
        RAISE NOTICE 'Building not found for Department ID: %. Teacher not added.', v_department_id;
        RETURN;
    END IF;

    -- Insert new teacher with all auto-linked data
    INSERT INTO teachers (
        teacher_id, full_name, gender, email, phone_number,
        course, course_id, department_id, building_id
    )
    VALUES (
        v_teacher_id, p_full_name, p_gender, p_email, p_phone_number,
        v_course_name, p_course_id, v_department_id, v_building_id
    );

    -- Confirmation message
    RAISE NOTICE 
        'Teacher % (ID: %) added successfully for course % (Course ID: %, Department ID: %, Building ID: %).',
        p_full_name, v_teacher_id, v_course_name, p_course_id, v_department_id, v_building_id;
END;
$$;


CALL add_teacher_test(
    'Maria Santos',
    'F',
    'maria.santssaos@school.edu',
    '09123456789',
    102
);
SELECT * FROM teachers


--------------------------------------------------------------------------------------------------------------------------------------

--POST DEPARTMENT

CREATE OR REPLACE PROCEDURE add_department(
    p_department_name VARCHAR,
    p_head_of_department VARCHAR,
    p_department_building_id INT
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_department_id INT;
BEGIN
    -- Generate next department_id automatically
    SELECT COALESCE(MAX(department_id), 0) + 1 INTO v_department_id FROM department;

    -- Check if the Department Name already exists
    IF EXISTS (SELECT 1 FROM department WHERE LOWER(department_name) = LOWER(p_department_name)) THEN
        RAISE NOTICE 'Department name "%" already exists. Department not added.', p_department_name;
        RETURN;
    END IF;

    -- Check if the building ID exists
    IF NOT EXISTS (SELECT 1 FROM main_building WHERE building_id = p_department_building_id) THEN
        RAISE NOTICE 'Building ID % does not exist. Department not added.', p_department_building_id;
        RETURN;
    END IF;

    -- Insert the new department
    INSERT INTO department (
        department_id, department_name, head_of_department, department_building_id
    )
    VALUES (
        v_department_id, p_department_name, p_head_of_department, p_department_building_id
    );

    RAISE NOTICE 'Department "%" (ID: %) added successfully under Building ID %.',
        p_department_name, v_department_id, p_department_building_id;
END;
$$;



CALL add_department('Business Administration', 'Mr. Delos Reyes', 12);
SELECT * FROM department;


--------------------------------------------------------------------------------------------------------------------------------------

--POST COURSE

CREATE OR REPLACE PROCEDURE add_course(
    p_course_name VARCHAR,
    p_course_code VARCHAR,
    p_credits INT,
    p_department_id INT
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_course_id INT;
BEGIN
    -- Generate next course_id automatically
    SELECT COALESCE(MAX(course_id), 0) + 1 INTO v_course_id FROM courses;

    -- Check if course name already exists
    IF EXISTS (SELECT 1 FROM courses WHERE LOWER(course_name) = LOWER(p_course_name)) THEN
        RAISE NOTICE 'Course name "%" already exists. Course not added.', p_course_name;
        RETURN;
    END IF;

    -- Check if course code already exists
    IF EXISTS (SELECT 1 FROM courses WHERE LOWER(course_code) = LOWER(p_course_code)) THEN
        RAISE NOTICE 'Course code "%" already exists. Course not added.', p_course_code;
        RETURN;
    END IF;

    -- Insert new course if all checks pass
    INSERT INTO courses (course_id, course_name, course_code, credits, department_id)
    VALUES (v_course_id, p_course_name, p_course_code, p_credits, p_department_id);

    RAISE NOTICE 'Course "%" (ID: %) added successfully under Department ID %.',
        p_course_name, v_course_id, p_department_id;
END;
$$;

CALL add_course('Capstone 1', 'Capsprog', 6, 33);
SELECT * FROM courses

--------------------------------------------------------------------------------------------------------------------------------------

--POST MAIN BUILDING

CREATE OR REPLACE PROCEDURE add_building(
    p_building_name VARCHAR,
    p_num_of_floors INT
)
LANGUAGE plpgsql
AS $$
DECLARE
    v_building_id INT;
BEGIN
    -- Generate the next building_id automatically
    SELECT COALESCE(MAX(building_id), 0) + 1 INTO v_building_id FROM main_building;

    -- Check if the building name already exists
    IF EXISTS (SELECT 1 FROM main_building WHERE LOWER(building_name) = LOWER(p_building_name)) THEN
        RAISE NOTICE 'Building name "%" already exists. Building not added.', p_building_name;
        RETURN;
    END IF;

    -- Insert new building
    INSERT INTO main_building (
        building_id, building_name, num_of_floors
    )
    VALUES (
        v_building_id, p_building_name, p_num_of_floors
    );

    RAISE NOTICE 'Building "%" (ID: %) added successfully with % floors.',
        p_building_name, v_building_id, p_num_of_floors;
END;
$$;


CALL add_building('Science Hall', 4);
CALL add_building('Engineering Tower', 6);

SELECT * FROM main_building




--------------------------------------------------------------------------------------------------------------------------------------

--DELETE RECORD STUDENT, TEACHER, COURSE

CREATE OR REPLACE PROCEDURE delete_method(p_id INT, p_type VARCHAR)
LANGUAGE plpgsql
AS $$
BEGIN
    -- Delete Department
    IF p_type = 'department' THEN
        IF EXISTS (SELECT 1 FROM department WHERE department_id = p_id) THEN
            DELETE FROM department WHERE department_id = p_id;
            RAISE NOTICE 'Department with ID % deleted successfully.', p_id;
        ELSE
            RAISE NOTICE 'Department with ID % does not exist.', p_id;
        END IF;

    -- Delete Student
    ELSIF p_type = 'student' THEN
        IF EXISTS (SELECT 1 FROM students WHERE student_id = p_id) THEN
            DELETE FROM students WHERE student_id = p_id;
            RAISE NOTICE 'Student with ID % deleted successfully.', p_id;
        ELSE
            RAISE NOTICE 'Student with ID % does not exist.', p_id;
        END IF;

    -- Delete Teacher
    ELSIF p_type = 'teacher' THEN
        IF EXISTS (SELECT 1 FROM teachers WHERE teacher_id = p_id) THEN
            DELETE FROM teachers WHERE teacher_id = p_id;
            RAISE NOTICE 'Teacher with ID % deleted successfully.', p_id;
        ELSE
            RAISE NOTICE 'Teacher with ID % does not exist.', p_id;
        END IF;

    -- Delete Course
    ELSIF p_type = 'course' THEN
        IF EXISTS (SELECT 1 FROM courses WHERE course_id = p_id) THEN
            DELETE FROM courses WHERE course_id = p_id;
            RAISE NOTICE 'Course with ID % deleted successfully.', p_id;
        ELSE
            RAISE NOTICE 'Course with ID % does not exist.', p_id;
        END IF;

    -- Invalid type
    ELSE
        RAISE NOTICE 'Invalid type. Use "department", "student", "teacher", or "course".';
    END IF;
END;
$$;



-- Delete student
CALL delete_method(59, 'student');

-- Delete teacher
CALL delete_method(46, 'teacher');
SELECT * FROM teachers

-- Delete teacher
CALL delete_method(45, 'teacher');
SELECT * FROM teachers;

-- Delete course
CALL delete_method(105, 'course');

-- Delete course
CALL delete_method(34, 'department');
SELECT * FROM department






--------------------------------------------------------------------------------------------------------------------------------------









SELECT * FROM students;
SELECT * FROM teachers;
SELECT * FROM courses;
SELECT * FROM department;
SELECT * FROM student_address;
SELECT * FROM annex_building;
SELECT * FROM main_building;


CREATE OR REPLACE PROCEDURE add_course(
    p_course_name VARCHAR,
    p_course_code VARCHAR,
    p_credits INT,
    p_department_id INT
)

CREATE OR REPLACE PROCEDURE add_student(
    p_full_name VARCHAR,
    p_gender CHAR,
    p_birth_date DATE,
    p_email VARCHAR,
    p_phone_number VARCHAR,
    p_course VARCHAR
)

CREATE OR REPLACE PROCEDURE add_department(
    p_department_name VARCHAR,
    p_head_of_department VARCHAR,
    p_department_building_id INT
)

CREATE OR REPLACE PROCEDURE add_building(
    p_building_name VARCHAR,
    p_num_of_floors INT
)

CREATE OR REPLACE PROCEDURE add_teacher(
    p_full_name VARCHAR,
    p_gender CHAR,
    p_email VARCHAR,
    p_phone_number VARCHAR,
    p_course VARCHAR
)

